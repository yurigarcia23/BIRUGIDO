<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BI Grupo Rugido</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

        :root {
            --header-bg: #1A2C50;
            --main-bg: #F4F7FC;
            --card-bg: #FFFFFF;
            --text-dark: #2D3748;
            --text-light: #718096;
            --highlight-pink: #E53E75;
            --border-color: #E2E8F0;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: var(--main-bg);
            color: var(--text-dark);
            font-family: 'Roboto', sans-serif;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* --- Header --- */
        header {
            background: var(--header-bg);
            color: white;
            padding: 0 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 64px;
            flex-shrink: 0;
        }

        header .logo { font-size: 1.5rem; font-weight: 700; }
        header .logo span { color: var(--highlight-pink); }

        header nav { display: flex; gap: 10px; }
        
        header .nav-link {
            color: #E2E8F0;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }
        header .nav-link:hover { background-color: rgba(255,255,255,0.1); }
        header .nav-link.active { background-color: var(--highlight-pink); color: white; }

        header .header-actions { display: flex; align-items: center; gap: 20px; }
        
        header .action-button {
            background: transparent;
            border: 1px solid var(--text-light);
            color: #E2E8F0;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        header .action-button:hover { background-color: rgba(255,255,255,0.1); border-color: white; }

        .profile-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #E2E8F0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .profile-icon:hover { border-color: var(--highlight-pink); }
        .profile-icon svg { color: #E2E8F0; }


        /* --- Main Content --- */
        main {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }
        
        .content-section { display: none; }
        .content-section.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        .page-header h2 { font-size: 2rem; color: var(--text-dark); margin: 0; }
        .page-header p { font-size: 1rem; color: var(--text-light); }

        .dashboard-filters {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        .filter-group label {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-bottom: 4px;
        }
        .filter-group select, .filter-group input {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            font-family: 'Roboto', sans-serif;
            font-size: 0.9rem;
        }
        #custom-date-filters {
            display: none; /* Oculto por padr√£o */
            gap: 15px;
        }
        #custom-date-filters.visible {
            display: flex;
        }

        /* --- Dashboard --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 24px;
        }
        
        .kpi-card-small {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03);
        }
        .kpi-card-small .title { 
            color: var(--text-light); 
            margin-bottom: 4px; 
            font-size: 0.9rem; 
            font-weight: 500;
        }
        .kpi-card-small .value { 
            font-size: 2rem; 
            font-weight: 700; 
        }

        .kpi-card-large {
            grid-column: span 6;
            background: var(--card-bg);
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            text-align: center;
        }
        .kpi-card-large .title { 
            color: var(--text-dark); 
            margin-bottom: 12px;
            padding-bottom: 12px;
            font-size: 1.2rem; 
            font-weight: 700;
            border-bottom: 1px solid var(--border-color);
        }
        .kpi-card-large .value { font-size: 2.5rem; font-weight: 700; color: var(--highlight-pink) }


        .widget {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }
        .widget h3 {
            margin: 0 0 20px 0;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-dark);
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .ranking-widget { grid-column: span 12; }

        .ranking-item { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .ranking-item .rank { font-size: 1rem; font-weight: 700; color: var(--text-light); width: 20px; }
        .ranking-item .avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--main-bg); display: flex; align-items: center; justify-content: center; font-weight: 700; }
        .ranking-item .info .name { font-weight: 500; }
        .ranking-item .info .details { color: var(--text-light); font-size: 0.9rem; }
        .ranking-item .value { margin-left: auto; font-weight: 700; font-size: 1.1rem; }
        
        .pipeline-widget {
            grid-column: span 6;
        }
        .pipeline-item {
            display: grid;
            grid-template-columns: 100px 1fr 40px;
            gap: 15px;
            align-items: center;
            margin-bottom: 16px;
        }
        .pipeline-label {
            color: var(--text-light);
            font-weight: 500;
            text-align: right;
        }
        .pipeline-bar-bg {
            width: 100%;
            height: 12px;
            background-color: var(--main-bg);
            border-radius: 6px;
        }
        .pipeline-bar-fg {
            height: 100%;
            background-color: var(--highlight-pink);
            border-radius: 6px;
            transition: width 0.5s ease-out;
        }
        .pipeline-value {
            font-weight: 700;
            text-align: left;
        }
        
        .channel-metrics-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }
        .channel-metric-item {
            text-align: center;
            padding: 15px;
            background: #F7FAFC;
            border-radius: 6px;
        }
        .channel-metric-item .channel-name {
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 15px;
        }
        .channel-metric-item .metric {
            display: flex;
            justify-content: space-between;
            font-size: 1rem;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .channel-metric-item .metric:last-child {
            border-bottom: none;
        }
        .channel-metric-item .metric-label {
            color: var(--text-light);
        }
        .channel-metric-item .metric-value {
            font-weight: 700;
        }


        /* --- Forms & Tables --- */
        form { max-width: 900px; margin: 0 auto; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { display: flex; flex-direction: column; }
        label { margin-bottom: 8px; font-weight: 500; color: var(--text-light); }
        input, select, textarea { background: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-dark); padding: 12px; border-radius: 6px; font-size: 1rem; font-family: 'Roboto', sans-serif; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--highlight-pink); box-shadow: 0 0 0 2px rgba(229, 62, 117, 0.2); }
        textarea { resize: vertical; min-height: 80px; }
        .full-width { grid-column: 1 / -1; }
        
        .form-section-divider {
            border-top: 1px solid var(--border-color);
            margin: 30px 0;
        }

        .lancamento-block {
            background: #FAFBFF;
            border: 1px dashed var(--border-color);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            position: relative;
        }
        .remove-lancamento-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #E2E8F0;
            color: var(--text-light);
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
        }
        .add-lancamento-btn {
            background: transparent;
            border: 1px dashed var(--text-light);
            color: var(--text-light);
            padding: 10px;
            width: 100%;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        button[type="submit"] { background: var(--highlight-pink); color: white; border: none; padding: 14px; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: 700; width: 100%; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9rem; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { background-color: #F7FAFC; font-weight: 500; color: var(--text-light); text-transform: uppercase; font-size: 0.8rem; }
        td { color: var(--text-dark); }
        .table-filters input, .table-filters select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.9rem;
        }

    </style>
</head>
<body>

    <div class="app-container">
        <header>
            <div class="logo">Grupo <span>Rugido</span></div>
            <nav>
                <a href="#" class="nav-link active" data-target="dashboard">Dashboard</a>
                <a href="#" class="nav-link" data-target="diario">Di√°rio</a>
                <a href="#" class="nav-link" data-target="historico">Hist√≥rico</a>
            </nav>
            <div class="header-actions">
                <button class="action-button">Sair</button>
                <div class="profile-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                </div>
            </div>
        </header>

        <main>
            <section id="dashboard" class="content-section active">
                <div class="page-header">
                    <div>
                        <h2>Dashboard</h2>
                        <p>Vis√£o geral das suas m√©tricas de prospec√ß√£o.</p>
                    </div>
                    <div class="dashboard-filters">
                        <div class="filter-group">
                            <label for="user-filter">Closer</label>
                            <select id="user-filter"></select>
                        </div>
                        <div class="filter-group">
                            <label for="channel-filter-dash">Canal</label>
                            <select id="channel-filter-dash">
                                <option value="all">Todos os Canais</option>
                                <option>Inbound</option>
                                <option>Outbound</option>
                                <option>Webinar</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="date-preset-filter">Per√≠odo</label>
                            <select id="date-preset-filter">
                                <option value="last7days">√öltimos 7 dias</option>
                                <option value="today">Hoje</option>
                                <option value="yesterday">Ontem</option>
                                <option value="this_month">Este M√™s</option>
                                <option value="all_time">M√°ximo</option>
                                <option value="custom">Personalizado</option>
                            </select>
                        </div>
                        <div id="custom-date-filters">
                            <div class="filter-group">
                                <label for="start-date-filter">De</label>
                                <input type="date" id="start-date-filter">
                            </div>
                            <div class="filter-group">
                                <label for="end-date-filter">At√©</label>
                                <input type="date" id="end-date-filter">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="dashboard-grid">
                    <div class="kpi-card-small" style="grid-column: span 2;"><div class="title">Reuni√µes Totais</div><div class="value" id="kpi-reunioes-totais">0</div></div>
                    <div class="kpi-card-small" style="grid-column: span 2;"><div class="title">Reuni√µes Realizadas</div><div class="value" id="kpi-realizadas">0</div></div>
                    <div class="kpi-card-small" style="grid-column: span 2;"><div class="title">Qualificadas</div><div class="value" id="kpi-qualificadas">0</div></div>
                    <div class="kpi-card-small" style="grid-column: span 2;"><div class="title">Desqualificadas</div><div class="value" id="kpi-desqualificadas">0</div></div>
                    <div class="kpi-card-small" style="grid-column: span 2;"><div class="title">Reagendadas</div><div class="value" id="kpi-reagendadas">0</div></div>
                    <div class="kpi-card-small" style="grid-column: span 2;"><div class="title">No Show</div><div class="value" id="kpi-no-show">0</div></div>

                    <div class="kpi-card-small" style="grid-column: span 4;"><div class="title">Propostas Enviadas</div><div class="value" id="kpi-propostas">0</div></div>
                    <div class="kpi-card-small" style="grid-column: span 4;"><div class="title">Valor Proposta em Aberto</div><div class="value" id="kpi-propostas-aberto">R$ 0,00</div></div>
                    <div class="kpi-card-small" style="grid-column: span 4;"><div class="title">Perdidas</div><div class="value" id="kpi-perdidas">0</div></div>
                    
                    <div class="kpi-card-large"><div class="title">Valor Total Vendido</div><div class="value" id="kpi-valor-vendas">R$ 0,00</div></div>
                    <div class="kpi-card-large"><div class="title">Neg√≥cios Ganhos</div><div class="value" id="kpi-vendas">0</div></div>
                    
                    <div class="widget" style="grid-column: span 12;">
                        <h3>Performance por Canal</h3>
                        <div class="channel-metrics-container" id="channel-metrics-container">
                            <!-- M√©tricas de canal ser√£o inseridas aqui -->
                        </div>
                    </div>

                    <div class="widget pipeline-widget">
                        <h3>Etapas de Reuni√£o</h3>
                        <div id="stage-pipeline-container"></div>
                    </div>

                    <div class="widget pipeline-widget">
                        <h3>Evolu√ß√£o do Funil</h3>
                        <div id="evolution-pipeline-container"></div>
                    </div>

                    <div class="widget ranking-widget">
                        <h3>Ranking de Vendas</h3>
                        <div id="ranking-container"></div>
                    </div>
                </div>
            </section>

            <section id="diario" class="content-section">
                <div class="page-header" style="text-align: center; display: block;">
                    <h2>Lan√ßamento Di√°rio</h2>
                    <p>Registre uma ou mais atividades de uma s√≥ vez.</p>
                </div>
                <form id="activity-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="date-preset-form">Per√≠odo</label>
                            <select id="date-preset-form">
                                <option value="today">Hoje</option>
                                <option value="yesterday">Ontem</option>
                                <option value="custom">Personalizado</option>
                            </select>
                        </div>
                        <div class="form-group" id="custom-date-form-group" style="display: none;">
                            <label for="date-form">Data do Evento</label>
                            <input type="date" id="date-form" required>
                        </div>
                        <div class="form-group"><label for="closer-name-form">Closer</label><select id="closer-name-form"><option>Yuri Garcia</option><option>Pedro Costa</option></select></div>
                    </div>

                    <div class="form-section-divider"></div>

                    <div id="lancamentos-container"></div>
                    
                    <button type="button" class="add-lancamento-btn" id="add-lancamento-btn">+ Adicionar Lan√ßamento</button>
                    
                    <div class="form-group full-width">
                        <button type="submit">Salvar Todos os Lan√ßamentos</button>
                    </div>
                </form>
            </section>

            <section id="historico" class="content-section">
                <div class="page-header">
                    <h2>Hist√≥rico de Atividades</h2>
                    <p>Visualize todos os registros do sistema.</p>
                </div>
                <div id="history-table-container"></div>
            </section>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            const navLinks = document.querySelectorAll('.nav-link');
            const contentSections = document.querySelectorAll('.content-section');
            navLinks.forEach(link => {link.addEventListener('click', (e) => {e.preventDefault();navLinks.forEach(l=>l.classList.remove('active'));contentSections.forEach(s=>s.classList.remove('active'));const targetId=link.getAttribute('data-target');document.getElementById(targetId).classList.add('active');link.classList.add('active');});});

            let activities = [
                { id: 1, date: '2025-07-03', closer: 'Yuri Garcia', lead: 'Sys-Tech', channel: 'Outbound', type: 'R1', status: 'Reuni√£o Realizada', evolution: 'De R1 para R2', saleValue: null, notes: 'Cliente demonstrou muito interesse.', qualification: 'Qualificado', companyRevenue: '500k+', proposalSent: 'Sim', proposalValue: 15000 },
                { id: 2, date: '2025-07-03', closer: 'Pedro Costa', lead: 'Inova Solu√ß√µes', channel: 'Webinar', type: 'R3', status: 'Venda Ganhada', evolution: '', saleValue: 12300, notes: 'Contrato assinado.', qualification: 'Qualificado', companyRevenue: '500k+', proposalSent: 'Sim', proposalValue: 12300 },
                { id: 3, date: '2025-07-02', closer: 'Yuri Garcia', lead: 'Data Prime', channel: 'Inbound', type: 'R2', status: 'Venda Ganhada', evolution: '', saleValue: 9800, notes: '', qualification: 'Qualificado', companyRevenue: '300k a 500k', proposalSent: 'Sim', proposalValue: 10000 },
                { id: 4, date: '2025-06-15', closer: 'Pedro Costa', lead: 'WebLink', channel: 'Outbound', type: 'R1', status: 'Venda Perdida', evolution: '', saleValue: null, notes: 'Optou por concorrente.', qualification: 'N√£o Qualificado', companyRevenue: '50k a 100k', proposalSent: 'N√£o', proposalValue: null },
            ];

            // --- Elementos do DOM ---
            const historyContainer = document.getElementById('history-table-container');
            const form = document.getElementById('activity-form');
            const lancamentosContainer = document.getElementById('lancamentos-container');
            const addLancamentoBtn = document.getElementById('add-lancamento-btn');
            const userFilter = document.getElementById('user-filter');
            const channelFilterDash = document.getElementById('channel-filter-dash');
            const datePresetFilter = document.getElementById('date-preset-filter');
            const customDateFilters = document.getElementById('custom-date-filters');
            const startDateFilter = document.getElementById('start-date-filter');
            const endDateFilter = document.getElementById('end-date-filter');
            const datePresetForm = document.getElementById('date-preset-form');
            const customDateFormGroup = document.getElementById('custom-date-form-group');
            const dateFormInput = document.getElementById('date-form');
            
            const toISODateString = (date) => date.toISOString().split('T')[0];

            const handleFormDatePresetChange = () => {
                const preset = datePresetForm.value;
                const today = new Date();
                let targetDate = new Date();

                if (preset === 'custom') {
                    customDateFormGroup.style.display = 'block';
                    return;
                }
                
                customDateFormGroup.style.display = 'none';

                switch(preset) {
                    case 'today':
                        break;
                    case 'yesterday':
                        targetDate.setDate(today.getDate() - 1);
                        break;
                }
                dateFormInput.value = toISODateString(targetDate);
            };

            datePresetForm.addEventListener('change', handleFormDatePresetChange);
            handleFormDatePresetChange();

            const formatCurrency = (value) => {
                if (typeof value !== 'number') return 'R$ 0,00';
                return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            };
            
            const createLancamentoBlock = () => {
                const blockId = `block-${Date.now()}`;
                const block = document.createElement('div');
                block.className = 'lancamento-block';
                block.id = blockId;
                block.innerHTML = `
                    <button type="button" class="remove-lancamento-btn" data-target="${blockId}">X</button>
                    <div class="form-grid">
                        <div class="form-group"><label for="lead-name-${blockId}">Lead/Empresa</label><input type="text" id="lead-name-${blockId}" required></div>
                        <div class="form-group"><label for="revenue-${blockId}">Faturamento da Empresa</label>
                            <select id="revenue-${blockId}">
                                <option>-50k</option>
                                <option>50k a 100k</option>
                                <option>100k a 200k</option>
                                <option>300k a 500k</option>
                                <option>500k+</option>
                            </select>
                        </div>
                        <div class="form-group"><label for="channel-${blockId}">Canal</label><select id="channel-${blockId}"><option>Inbound</option><option>Outbound</option><option>Webinar</option></select></div>
                        <div class="form-group"><label for="qualification-${blockId}">Qualifica√ß√£o</label><select id="qualification-${blockId}"><option>Qualificado</option><option>N√£o Qualificado</option></select></div>
                        <div class="form-group"><label for="activity-type-${blockId}">Tipo de Reuni√£o</label><select id="activity-type-${blockId}"><option value="">N/A</option><option>R1</option><option>R2</option><option>R3</option><option>R4</option></select></div>
                        <div class="form-group"><label for="activity-status-${blockId}">Status da Atividade</label><select id="activity-status-${blockId}"><option>Reuni√£o Realizada</option><option>Reuni√£o Reagendada</option><option>No Show</option><option>Venda Ganhada</option><option>Venda Perdida</option></select></div>
                        <div class="form-group"><label for="proposal-sent-${blockId}">Proposta Enviada?</label><select id="proposal-sent-${blockId}"><option>N√£o</option><option>Sim</option></select></div>
                        <div class="form-group"><label for="funnel-evolution-${blockId}">Evolu√ß√£o no Funil</label><select id="funnel-evolution-${blockId}"><option value="">Nenhuma</option><option>De R1 para R2</option><option>De R2 para R3</option><option>De R3 para R4</option></select></div>
                        <div class="form-group"><label for="proposal-value-${blockId}">Valor da Proposta (R$)</label><input type="number" id="proposal-value-${blockId}" placeholder="7000"></div>
                        <div class="form-group"><label for="sale-value-${blockId}">Valor da Venda (R$)</label><input type="number" id="sale-value-${blockId}" placeholder="5000"></div>
                        <div class="form-group full-width"><label for="notes-${blockId}">Observa√ß√µes</label><textarea id="notes-${blockId}" placeholder="Adicione notas sobre a negocia√ß√£o..."></textarea></div>
                    </div>
                `;
                lancamentosContainer.appendChild(block);
            };

            addLancamentoBtn.addEventListener('click', createLancamentoBlock);
            lancamentosContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-lancamento-btn')) {
                    const targetId = e.target.getAttribute('data-target');
                    document.getElementById(targetId).remove();
                }
            });

            // --- L√≥gica de Filtros e Atualiza√ß√£o ---
            
            const filterActivities = () => {
                const selectedUser = userFilter.value;
                const selectedChannel = channelFilterDash.value;
                const startDate = startDateFilter.value ? new Date(startDateFilter.value + 'T00:00:00') : null;
                const endDate = endDateFilter.value ? new Date(endDateFilter.value + 'T23:59:59') : null;

                return activities.filter(act => {
                    const activityDate = new Date(act.date);
                    const userMatch = selectedUser === 'all' || act.closer === selectedUser;
                    const channelMatch = selectedChannel === 'all' || act.channel === selectedChannel;
                    const startDateMatch = !startDate || activityDate >= startDate;
                    const endDateMatch = !endDate || activityDate <= endDate;
                    return userMatch && channelMatch && startDateMatch && endDateMatch;
                });
            };

            const updateAllData = () => {
                const filteredData = filterActivities();
                updateDashboard(filteredData);
                updateRanking(filteredData);
                updatePipelineWidgets(filteredData);
                updateChannelMetrics(filteredData);
                renderTable(); // A tabela sempre mostra todos os dados, mas os filtros dela se aplicam
            };

            const updateDashboard = (data) => {
                const vendas = data.filter(act => act.status === 'Venda Ganhada');
                const receitaTotal = vendas.reduce((sum, act) => sum + act.saleValue, 0);
                
                document.getElementById('kpi-valor-vendas').textContent = formatCurrency(receitaTotal);
                document.getElementById('kpi-vendas').textContent = vendas.length;
                document.getElementById('kpi-propostas').textContent = data.filter(act => act.proposalSent === 'Sim').length;
                document.getElementById('kpi-perdidas').textContent = data.filter(act => act.status === 'Venda Perdida').length;
                document.getElementById('kpi-reunioes-totais').textContent = data.length;
                document.getElementById('kpi-qualificadas').textContent = data.filter(act => act.qualification === 'Qualificado').length;
                document.getElementById('kpi-desqualificadas').textContent = data.filter(act => act.qualification === 'N√£o Qualificado').length;
                document.getElementById('kpi-reagendadas').textContent = data.filter(act => act.status === 'Reuni√£o Reagendada').length;
                document.getElementById('kpi-realizadas').textContent = data.filter(act => act.status === 'Reuni√£o Realizada').length;
                document.getElementById('kpi-no-show').textContent = data.filter(act => act.status === 'No Show').length;

                const leadsComProposta = new Set(data.filter(act => act.proposalSent === 'Sim').map(act => act.lead));
                const leadsFechados = new Set(data.filter(act => act.status === 'Venda Ganhada' || act.status === 'Venda Perdida').map(act => act.lead));
                const leadsAbertosComProposta = [...leadsComProposta].filter(lead => !leadsFechados.has(lead));
                let valorPropostasAbertas = 0;
                leadsAbertosComProposta.forEach(lead => {
                    const propostasDoLead = data.filter(act => act.lead === lead && act.proposalValue > 0).sort((a, b) => new Date(b.date) - new Date(a.date));
                    if (propostasDoLead.length > 0) { valorPropostasAbertas += propostasDoLead[0].proposalValue; }
                });
                document.getElementById('kpi-propostas-aberto').innerHTML = formatCurrency(valorPropostasAbertas);
            };
            
            const updateChannelMetrics = (data) => {
                const container = document.getElementById('channel-metrics-container');
                const channels = ['Inbound', 'Outbound', 'Webinar'];
                let html = '';

                channels.forEach(channel => {
                    const channelData = data.filter(act => act.channel === channel);
                    const channelSales = channelData.filter(act => act.status === 'Venda Ganhada');
                    const channelRevenue = channelSales.reduce((sum, act) => sum + act.saleValue, 0);
                    
                    html += `
                        <div class="channel-metric-item">
                            <div class="channel-name">${channel}</div>
                            <div class="metric">
                                <span class="metric-label">Reuni√µes</span>
                                <span class="metric-value">${channelData.length}</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Vendas</span>
                                <span class="metric-value">${channelSales.length}</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Valor Vendas</span>
                                <span class="metric-value">${formatCurrency(channelRevenue)}</span>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            };

            const updatePipelineWidgets = (data) => {
                const stageContainer = document.getElementById('stage-pipeline-container');
                const evolutionContainer = document.getElementById('evolution-pipeline-container');

                const stages = ['R1', 'R2', 'R3', 'R4'];
                const stageCounts = stages.map(stage => data.filter(act => act.type === stage).length);
                const maxStageCount = Math.max(...stageCounts, 1);

                let stageHTML = '';
                stages.forEach((stage, index) => {
                    const count = stageCounts[index];
                    const widthPercent = (count / maxStageCount) * 100;
                    stageHTML += `<div class="pipeline-item"><div class="pipeline-label">${stage}</div><div class="pipeline-bar-bg"><div class="pipeline-bar-fg" style="width: ${widthPercent}%;"></div></div><div class="pipeline-value">${count}</div></div>`;
                });
                stageContainer.innerHTML = stageHTML;

                const evolutions = ['De R1 para R2', 'De R2 para R3', 'De R3 para R4'];
                const evolutionCounts = evolutions.map(evo => data.filter(act => act.evolution === evo).length);
                const maxEvolutionCount = Math.max(...evolutionCounts, 1);

                let evolutionHTML = '';
                evolutions.forEach((evo, index) => {
                    const count = evolutionCounts[index];
                    const widthPercent = (count / maxEvolutionCount) * 100;
                    evolutionHTML += `<div class="pipeline-item"><div class="pipeline-label">${evo.replace('De ', '').replace(' para ', ' > ')}</div><div class="pipeline-bar-bg"><div class="pipeline-bar-fg" style="width: ${widthPercent}%;"></div></div><div class="pipeline-value">${count}</div></div>`;
                });
                evolutionContainer.innerHTML = evolutionHTML;
            };

            const updateRanking = (data) => {
                const rankingContainer = document.getElementById('ranking-container');
                const salesByCloser = data.filter(act => act.status === 'Venda Ganhada' && act.saleValue > 0).reduce((acc, act) => {
                    if (!acc[act.closer]) { acc[act.closer] = { total: 0, count: 0 }; }
                    acc[act.closer].total += act.saleValue; acc[act.closer].count++; return acc;
                }, {});
                const sortedClosers = Object.entries(salesByCloser).map(([name, d]) => ({ name, ...d })).sort((a, b) => b.total - a.total);
                let rankingHTML = '';
                if (sortedClosers.length === 0) { rankingHTML += '<p>Nenhuma venda registrada no per√≠odo.</p>'; } 
                else { sortedClosers.forEach((closer, index) => {
                    const initials = closer.name.split(' ').map(n => n[0]).join('');
                    rankingHTML += `<div class="ranking-item"><div class="rank">#${index+1}</div><div class="avatar">${initials}</div><div class="info"><div class="name">${closer.name}</div><div class="details">${closer.count} vendas</div></div><div class="value">${formatCurrency(closer.total)}</div></div>`;
                });}
                rankingContainer.innerHTML = rankingHTML;
            };

            const renderTable = () => {
                const tableBody = document.querySelector('#history-table-container table tbody');
                if (!tableBody) {
                    historyContainer.innerHTML = `
                        <table>
                            <thead>
                                <tr><th>Data</th><th>Closer</th><th>Lead</th><th>Canal</th><th>Faturamento</th><th>Qualifica√ß√£o</th><th>Status</th><th>Vlr. Proposta</th><th>Vlr. Venda</th><th>Notas</th></tr>
                                <tr class="table-filters">
                                    <td><input type="date" class="history-filter" data-key="date"></td>
                                    <td><select class="history-filter" data-key="closer"></select></td>
                                    <td><input type="text" class="history-filter" data-key="lead" placeholder="Filtrar..."></td>
                                    <td><select class="history-filter" data-key="channel"></select></td>
                                    <td><select class="history-filter" data-key="companyRevenue"></select></td>
                                    <td><select class="history-filter" data-key="qualification"></select></td>
                                    <td><select class="history-filter" data-key="status"></select></td>
                                    <td></td>
                                    <td></td>
                                    <td><input type="text" class="history-filter" data-key="notes" placeholder="Filtrar..."></td>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    `;
                    // Populate filter dropdowns
                    const getUniqueOptions = (key) => ['Todos', ...new Set(activities.map(act => act[key]))];
                    
                    const closerFilter = document.querySelector('.table-filters [data-key="closer"]');
                    getUniqueOptions('closer').forEach(opt => closerFilter.innerHTML += `<option>${opt}</option>`);

                    const channelFilter = document.querySelector('.table-filters [data-key="channel"]');
                    getUniqueOptions('channel').forEach(opt => channelFilter.innerHTML += `<option>${opt}</option>`);

                    const revenueFilter = document.querySelector('.table-filters [data-key="companyRevenue"]');
                    getUniqueOptions('companyRevenue').forEach(opt => revenueFilter.innerHTML += `<option>${opt}</option>`);

                    const qualificationFilter = document.querySelector('.table-filters [data-key="qualification"]');
                    getUniqueOptions('qualification').forEach(opt => qualificationFilter.innerHTML += `<option>${opt}</option>`);
                    
                    const statusFilter = document.querySelector('.table-filters [data-key="status"]');
                    getUniqueOptions('status').forEach(opt => statusFilter.innerHTML += `<option>${opt}</option>`);

                    document.querySelectorAll('.history-filter').forEach(filter => filter.addEventListener('input', renderTable));
                }

                const filters = {};
                document.querySelectorAll('.history-filter').forEach(f => { filters[f.dataset.key] = f.value; });

                const filteredActivities = activities.filter(act => {
                    return Object.entries(filters).every(([key, value]) => {
                        if (!value || value === 'Todos') return true;
                        if (key === 'date') return act.date === value;
                        return String(act[key]).toLowerCase().includes(value.toLowerCase());
                    });
                });

                const finalTableBody = document.querySelector('#history-table-container table tbody');
                finalTableBody.innerHTML = '';
                filteredActivities.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(act => {
                    finalTableBody.innerHTML += `<tr><td>${new Date(act.date).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</td><td>${act.closer}</td><td>${act.lead}</td><td>${act.channel}</td><td>${act.companyRevenue || 'N/A'}</td><td>${act.qualification}</td><td>${act.status}</td><td>${act.proposalValue ? formatCurrency(act.proposalValue) : 'N/A'}</td><td>${act.saleValue ? formatCurrency(act.saleValue) : 'N/A'}</td><td>${act.notes}</td></tr>`;
                });
            };
            
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const headerData = { date: document.getElementById('date-form').value, closer: document.getElementById('closer-name-form').value };
                const lancamentoBlocks = document.querySelectorAll('.lancamento-block');
                const newActivities = [];
                lancamentoBlocks.forEach(block => {
                    const blockId = block.id;
                    const newActivity = { ...headerData, id: Date.now() + Math.random(), 
                        lead: document.getElementById(`lead-name-${blockId}`).value, 
                        channel: document.getElementById(`channel-${blockId}`).value, 
                        type: document.getElementById(`activity-type-${blockId}`).value, 
                        status: document.getElementById(`activity-status-${blockId}`).value, 
                        evolution: document.getElementById(`funnel-evolution-${blockId}`).value, 
                        saleValue: parseFloat(document.getElementById(`sale-value-${blockId}`).value) || null, 
                        proposalValue: parseFloat(document.getElementById(`proposal-value-${blockId}`).value) || null,
                        notes: document.getElementById(`notes-${blockId}`).value,
                        qualification: document.getElementById(`qualification-${blockId}`).value,
                        companyRevenue: document.getElementById(`revenue-${blockId}`).value,
                        proposalSent: document.getElementById(`proposal-sent-${blockId}`).value,
                    };
                    if(newActivity.lead) newActivities.push(newActivity);
                });
                if (newActivities.length === 0) { alert('Adicione e preencha pelo menos um lan√ßamento antes de salvar.'); return; }
                activities.unshift(...newActivities);
                alert(`${newActivities.length} lan√ßamento(s) salvo(s) com sucesso!`);
                lancamentosContainer.innerHTML = '';
                createLancamentoBlock();
                renderTable();
                populateUserFilter();
                updateAllData();
            });
            
            const handleDatePresetChange = () => {
                const preset = datePresetFilter.value;
                const today = new Date();
                let start = new Date();
                let end = new Date();

                if (preset === 'custom') {
                    customDateFilters.classList.add('visible');
                    return;
                }
                
                customDateFilters.classList.remove('visible');

                switch(preset) {
                    case 'today':
                        break;
                    case 'yesterday':
                        start.setDate(today.getDate() - 1);
                        end.setDate(today.getDate() - 1);
                        break;
                    case 'this_month':
                        start = new Date(today.getFullYear(), today.getMonth(), 1);
                        end = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                        break;
                    case 'last7days':
                        start.setDate(today.getDate() - 6);
                        break;
                    case 'all_time':
                        start = null;
                        end = null;
                        break;
                }
                
                startDateFilter.value = start ? toISODateString(start) : '';
                endDateFilter.value = end ? toISODateString(end) : '';
                updateAllData();
            };

            const populateUserFilter = () => {
                const closers = [...new Set(activities.map(act => act.closer))];
                userFilter.innerHTML = '<option value="all">Todos os Usu√°rios</option>';
                closers.forEach(closer => {
                    const option = document.createElement('option');
                    option.value = closer;
                    option.textContent = closer;
                    userFilter.appendChild(option);
                });
            };

            // --- Event Listeners para Filtros ---
            userFilter.addEventListener('change', updateAllData);
            channelFilterDash.addEventListener('change', updateAllData);
            datePresetFilter.addEventListener('change', handleDatePresetChange);
            startDateFilter.addEventListener('change', () => {
                datePresetFilter.value = 'custom';
                customDateFilters.classList.add('visible');
                updateAllData();
            });
            endDateFilter.addEventListener('change', () => {
                datePresetFilter.value = 'custom';
                customDateFilters.classList.add('visible');
                updateAllData();
            });

            // --- Renderiza√ß√£o Inicial ---
            createLancamentoBlock();
            renderTable();
            populateUserFilter();
            handleDatePresetChange();
        });
    </script>

</body>
</html>
